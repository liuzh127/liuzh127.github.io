---
layout: post
title: MySQL安装
categories: [数据库]
tags: [MySQL]
---
#### 1. 软件版本
数据库版本为解压版MySQL [mysql-5.7.22-el7-x86_64.tar.gz](https://downloads.mysql.com/archives/community/)
#### 2. 查看系统之前是否有安装过mysql相关版本
`# rpm -qa|grep mysql`  
`# rpm -qa|grep mariadb`  
`# rpm -qa|grep mysql|xargs rpm -e --nodeps`  
`# rpm -qa|grep mariadb|xargs rpm -e --nodeps`  
#### 3. 检查mysql组和用户是否存在，如无创建
`# cat /etc/group|grep mysql`  
*mysql：x:27*  
`# cat /etc/passwd|grep mysql`  
*mysql：x:27:27:MySQL Server:/var/lib/mysql:/bin/false*  
*以上为默认存在的情况，如无，执行添加命令：*   
`# groupadd mysql`  
`# useradd -r -g mysql -s /bin/false mysql`  
*-r参数表示用户是系统用户，不可用于登录系统*
#### 4. 数据库软件准备
`# tar -xzvf mysql-5.7.22-el7-x86_64.tar.gz`  
`# mv mysql-5.7.22-el7-x86_64 /home/mysql`  
`# mkdir /home/data`  
`# chown -R mysql:mysql /home/mysql`  
#### 5. 初始化数据库
`# cd /home/mysql/bin`  
`# ./mysqld --initialize --user=mysql --basedir=/home/mysql/ --datadir=/home/data/`  
*记住初始密码（ZBy%#Uh45%gj）*  
#### 6. 配置数据库
`# vim /etc/my.cnf`  
```
[mysqld]
basedir = /home/mysql/
datadir = /home/data/
character-set-server = utf8
pid-file=/home/data/mysqld.pid
back_log=1024
wait_timeout=1800
max_connections=3200
max_user_connections=800
skip-name-resolve
innodb_buffer_pool_size=100M
innodb_log_buffer_size=20M
read_buffer_size=10M
sort_buffer_size=10M
read_rnd_buffer_size=10M
server-id=100
log-bin= master
[mysql]
default-character-set=utf8
```
#### 7. 配置解释
**back_log=1024**  
back_log的值指出在mysql暂时停止回答新请求之前的短时间内多少个请求可以被存在堆栈中。也就是说，如果mysql的连接数据达到max_connections时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即back_log，如果等待连接的数量超过back_log，将不被授予连接资源。  
**wait_timeout=1800**  
mysql连接闲置超过此设定值的时间后将会被强行关闭，单位是秒。  
**max_connections=3200**  
指mysql的最大连接数，如果服务器的并发连接请求量比较大，建议调高此值，以增加并行连接数量，当然这是建立在机器能支撑的情况下，因为如果连接数越多，介于mysql会为每个连接提供连接缓冲区，就会开销越多的内存，所以要适当调整该值，不能盲目提高设值。  
**max_user_connections=800**  
指每个数据库用户的最大连接。针对某一个账号的所有客户端并行连接到mysql服务的最大并行连接数。简单说是指同一个账号能够同时连接到mysql服务的最大连接数。设置为0表示不限制。  
**thread_concurrency=CPU核数x2**  
此值应设为CPU核数的2倍。  
**skip-name-resolve**  
禁止mysql对外部连接进行DNS解析，使用这一选项可以消除mysql进行DNS解析的时间。  
**innodb_buffer_pool_size<=服务器内存x0.7**  
用于缓存索引和数据的内存大小。  
**innodb_log_buffer_size=20M**  
InnoDB存储引擎的事务日志所使用的缓冲区。  
**read_buffer_size=10M**  
这个值代表读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区。  
**sort_buffer_size=10M**  
执行排序使用的缓冲大小。  
**read_rnd_buffer\_size=10M**  
随机读缓冲区大小。当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区。进行排序查询时，mysql会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。  
**binlog=日志名字**  
mysql的二进制日志是mysql最重要的日志，它记录了所有的DDL和DML语句，以事件形式记录，还包含语句所执行的消耗的时间，mysql的二进制日志是事务安全型的。
#### 8. 启动MySQL
`# cp /home/mysql/support-files/mysql.server /etc/init.d/mysqld`  
`# service mysqld start`  
**若数据库启动失败，则通过日志查看一下错误原因**  
`# cat /home/data/localhost.localdomain.err`  
**若错误提示为thread_concurrency=4，将my.cnf中此项删除即可**  
[配置开机启动项]  
`# chkconfig --add mysqld`  
`# chkconfig --level 2345 mysqld on`   
*`chkconfig --list`可以查看所有启动项*  
*`chkconfig --del mysqld`删除启动项*  
#### 9. 修改密码
`# mysql_secure_installation`  
**如果提示找不到此命令，则首先查看是否包括此命令**  
`# cd /home/mysql/bin`  
`# ls`   
**如果存在则把它添加到path中，命令如下：**  
`# cd `  
`# vi .bash_profile`  
`PATH=$PATH:$HOME/bin`**改为**`PATH=$PATH:/home/mysql/bin`  
**保存后执行命令**  
`# source .bash_profile`  
**再次执行修改密码命令**  
`# mysql_secure_installation`  
#### 10. 修改远程访问权限
`# mysql -uroot -p`  
**输入密码回车后开始本地mysql操作**  
`mysql> use mysql;`  
`mysql> update user set host='%' where user='root' and host='localhost';`  
`mysql> flush privileges;`    
#### 11. 主从复制
**配置注意事项**  
1.主从服务器操作系统版本和位数一致  
2.两台数据库服务器的的selinux都要disable  
3.Master和Slave数据库的版本要一致  
4.Master和Slave数据库中数据要一致  
5.Master开启二进制日志，Master和Slave的server_id在局域网内必须唯一  
##### 1. master配置
`# vim /etc/my.cnf`  
在**[mysqld]**中增加  
[server_id，一般设置为 IP]  
`server_id = 151`  
[复制过滤： 需要同步的数据库名，如果有多个数据库，可重复此参数，每个数据库一行]  
`binlog-do-db = test`  
[开启二进制日志功能， 可以随便取， 最好有含义]  
`log-bin = /usr/local/mysql/log/mysql-bin.log`  
[为每个 session 分配的内存，在事务过程中用来存储二进制日志的缓存]  
`binlog_cache_size = 1M`  
[主从复制的格式（mixed,statement,row，默认格式是 statement）]  
`binlog_format = mixed`  
[二进制日志自动删除/过期的天数。默认值为 0，表示不自动删除]  
`expire_logs_days = 7`  
[跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。如1062错误是指一些主键重复,1032错误是因为主从数据库数据不一致]  
`slave_skip_errors = ALL`  
[relay_log 配置中继日志]  
`relay_log = /usr/local/mysql/log/mysql-relay-bin.log`  
[log_slave_updates 表示 slave 将复制事件写进自己的二进制日志]  
`log_slave_updates = 1`  
[sync_binlog表示每几次事务提交，MySQL把binlog缓存刷进日志文件中，默认是0，最安全的是设置为1]  
`sync_binlog = 1`  
**其他参数说明*  
`replicate-ignore-db=mysql,information_schema,performance_schema`  
[不同步mysql系统数据库]  
`replicate_wild_do_table 和 replicate_wild_ignore_table`  
[参数解决同步所有跨数据库的更新，与replicate-do-db或者replicate-ignore-db类似]  
`auto_increment_increment和auto_increment_offset`  
[这两个参数一般用在主主同步中，用来错开自增值,防止键值冲突]  
`slave-skip-errors= [err1,err2,…….|ALL]`  
[用来定义复制过程中从服务器可以自动跳过的错误号（1062,1053,1146），当复制过程中遇到定义的错误号，就可以自动跳过，直接执行后面的SQL语句,慎用,当启动这个参数，MYSQL会忽略那些错误，可能造成主从数据库的数据不同步。]  
`master-connect-retry`  
[这个参数是用来设置在和主服务器连接丢失的时候，重试的时间间隔，默认是60秒]  
`log-slave-updates`  
[这个参数用来配置从服务器的更新是否写入二进制日志，这个选项默认是不打开的，但是，如果这个从服务器B是服务器A的从服务器，同时还作为服务器C的主服务器，那么就需要开发这个选项，这样它的从服务器C才能获得它的二进制日志进行同步操作]  
**创建数据同步用户**  
`mysql> grant replication slave on *.* to 'es1'@'192.168.0.%' identified by '123456';`  
`mysql> flush privileges;`  
`mysql> show master status;`  
+------------------+----------+--------------+------------------+-------------------+  
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |  
+------------------+----------+--------------+------------------+-------------------+  
| mysql-bin.000001 |      154 |              |                  |                   |  
+------------------+----------+--------------+------------------+-------------------+  
1 row in set (0.00 sec)  
##### 2. slave配置
**server_id = 128，其它配置项与master一致**  
**配置同步参数**  
`mysql> change master to master_host='192.168.76.127', master_user='es1', master_password='123456', master_port=3306,master_log_file='mysql-bin.000001', master_log_pos=154, master_connect_retry=30;`  
`mysql> flush privileges;`  
`show slave status\G;`  
*可看到Slave_IO_State为空,Slave_IO_Running和Slave_SQL_Running是 No,表明此时Slave还没有开始复制过程*  
**开启主从同步**  
`mysql> start slave;`  
`mysql> show slave status\G;`  
*************************** 1. row ***************************  
               Slave_IO_State: Waiting for master to send event  
                  Master_Host: 192.168.76.127  
                  Master_User: es1  
                  Master_Port: 3306  
                Connect_Retry: 30  
              Master_Log_File: mysql-bin.000001  
          Read_Master_Log_Pos: 591  
               Relay_Log_File: mysql-relay-bin.000002  
                Relay_Log_Pos: 320  
        Relay_Master_Log_File: mysql-bin.000001  
             Slave_IO_Running: Yes  
            Slave_SQL_Running: Yes  
              Replicate_Do_DB:   
          Replicate_Ignore_DB:   
           Replicate_Do_Table:   
       Replicate_Ignore_Table:   
      Replicate_Wild_Do_Table:   
  Replicate_Wild_Ignore_Table:   
                   Last_Errno: 0  
                   Last_Error:   
                 Skip_Counter: 0  
          Exec_Master_Log_Pos: 591  
              Relay_Log_Space: 527  
              Until_Condition: None  
               Until_Log_File:   
                Until_Log_Pos: 0  
           Master_SSL_Allowed: No  
           Master_SSL_CA_File:   
           Master_SSL_CA_Path:   
              Master_SSL_Cert:   
            Master_SSL_Cipher:   
               Master_SSL_Key:   
        Seconds_Behind_Master: 0  
Master_SSL_Verify_Server_Cert: No  
                Last_IO_Errno: 0  
                Last_IO_Error:   
               Last_SQL_Errno: 0  
               Last_SQL_Error:   
  Replicate_Ignore_Server_Ids:   
             Master_Server_Id: 127  
                  Master_UUID: 78422bb7-124e-11ea-9179-000c290acc5f  
             Master_Info_File: /usr/local/mysql/data/master.info  
                    SQL_Delay: 0  
          SQL_Remaining_Delay: NULL  
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates  
           Master_Retry_Count: 86400  
                  Master_Bind:   
      Last_IO_Error_Timestamp:   
     Last_SQL_Error_Timestamp:   
               Master_SSL_Crl:   
           Master_SSL_Crlpath:   
           Retrieved_Gtid_Set:   
            Executed_Gtid_Set:   
                Auto_Position: 0  
         Replicate_Rewrite_DB:   
                 Channel_Name:   
           Master_TLS_Version:   
1 row in set (0.00 sec)  
  
ERROR:   
No query specified  
**至此，mysql主从复制配置完成，在master上对数据库的操作会自动同步到salve上**  
#### 12. 主主复制
